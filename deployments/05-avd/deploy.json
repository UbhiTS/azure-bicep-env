{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.9.1.41621",
      "templateHash": "7671982447733365904"
    }
  },
  "variables": {
    "$fxv#0": {
      "deploymentName": "primary",
      "addressPrefix": "10.1.0.0/16",
      "rg": {
        "name": "contoso-primary-rg",
        "location": "westus2"
      },
      "nsg": {
        "name": "default-nsg"
      },
      "hub": {
        "name": "primary-hub-vnet",
        "addressPrefixes": [
          "10.1.0.0/20"
        ],
        "addressPrefixInfo": "https://jodies.de/ipcalc?host=10.1.0.0&mask1=20&mask2=",
        "subnets": {
          "aaddsSubnet": {
            "name": "aadds-subnet",
            "CIDR": "10.1.0.0/24"
          },
          "gatewaySubnet": {
            "name": "GatewaySubnet",
            "CIDR": "10.1.1.0/27"
          },
          "routeServerSubnet": {
            "name": "RouteServerSubnet",
            "CIDR": "10.1.1.32/27"
          },
          "azureFirewallSubnet": {
            "name": "AzureFirewallSubnet",
            "CIDR": "10.1.1.64/26"
          },
          "azureFirewallManagementSubnet": {
            "name": "AzureFirewallManagementSubnet",
            "CIDR": "10.1.1.128/26"
          },
          "azureBastionSubnet": {
            "name": "AzureBastionSubnet",
            "CIDR": "10.1.1.192/26"
          },
          "azureVirtualWANHub": {
            "name": "AzureVirtualWANHub",
            "CIDR": "10.1.2.0/24"
          },
          "dmzSubnet": {
            "name": "dmz-subnet",
            "CIDR": "10.1.3.0/24"
          }
        }
      }
    },
    "$fxv#1": {
      "deploymentName": "secondary",
      "addressPrefix": "10.2.0.0/16",
      "rg": {
        "name": "contoso-secondary-rg",
        "location": "eastus2"
      },
      "nsg": {
        "name": "default-nsg"
      },
      "hub": {
        "name": "secondary-hub-vnet",
        "addressPrefixes": [
          "10.2.0.0/20"
        ],
        "addressPrefixInfo": "https://jodies.de/ipcalc?host=10.2.0.0&mask1=20&mask2=",
        "subnets": {
          "aaddsSubnet": {
            "name": "aadds-subnet",
            "CIDR": "10.2.0.0/24"
          },
          "gatewaySubnet": {
            "name": "GatewaySubnet",
            "CIDR": "10.2.1.0/27"
          },
          "routeServerSubnet": {
            "name": "RouteServerSubnet",
            "CIDR": "10.2.1.32/27"
          },
          "azureFirewallSubnet": {
            "name": "AzureFirewallSubnet",
            "CIDR": "10.2.1.64/26"
          },
          "azureFirewallManagementSubnet": {
            "name": "AzureFirewallManagementSubnet",
            "CIDR": "10.2.1.128/26"
          },
          "azureBastionSubnet": {
            "name": "AzureBastionSubnet",
            "CIDR": "10.2.1.192/26"
          },
          "azureVirtualWANHub": {
            "name": "AzureVirtualWANHub",
            "CIDR": "10.2.2.0/24"
          },
          "dmzSubnet": {
            "name": "dmz-subnet",
            "CIDR": "10.2.3.0/24"
          }
        }
      }
    },
    "$fxv#2": {
      "deploymentName": "tertiary",
      "addressPrefix": "10.3.0.0/16",
      "rg": {
        "name": "contoso-tertiary-rg",
        "location": "southcentralus"
      },
      "nsg": {
        "name": "default-nsg"
      },
      "hub": {
        "name": "tertiary-hub-vnet",
        "addressPrefixes": [
          "10.3.0.0/20"
        ],
        "addressPrefixInfo": "https://jodies.de/ipcalc?host=10.3.0.0&mask1=20&mask2=",
        "subnets": {
          "aaddsSubnet": {
            "name": "aadds-subnet",
            "CIDR": "10.3.0.0/24"
          },
          "gatewaySubnet": {
            "name": "GatewaySubnet",
            "CIDR": "10.3.1.0/27"
          },
          "routeServerSubnet": {
            "name": "RouteServerSubnet",
            "CIDR": "10.3.1.32/27"
          },
          "azureFirewallSubnet": {
            "name": "AzureFirewallSubnet",
            "CIDR": "10.3.1.64/26"
          },
          "azureFirewallManagementSubnet": {
            "name": "AzureFirewallManagementSubnet",
            "CIDR": "10.3.1.128/26"
          },
          "azureBastionSubnet": {
            "name": "AzureBastionSubnet",
            "CIDR": "10.3.1.192/26"
          },
          "azureVirtualWANHub": {
            "name": "AzureVirtualWANHub",
            "CIDR": "10.3.2.0/24"
          },
          "dmzSubnet": {
            "name": "dmz-subnet",
            "CIDR": "10.3.3.0/24"
          }
        }
      }
    },
    "$fxv#3": {
      "deploymentName": "primary",
      "avd": {
        "hostPoolName": "dev-host-pool",
        "hostPoolFriendlyName": "Developers Host Pool",
        "appGroupName": "dev-app-group",
        "appGroupFriendlyName": "Developers Application Group",
        "workspaceName": "dev-workspace",
        "workspaceFriendlyName": "Developers Workspace",
        "appGroupType": "Desktop",
        "preferredAppGroupType": "Desktop",
        "hostPoolType": "pooled",
        "loadBalancerType": "BreadthFirst"
      },
      "sessionHosts": {
        "count": 1,
        "vmSize": "Standard_D2s_v5",
        "namePrefix": "dev-vm",
        "vmImageOffer": "Office-365",
        "vmImageSku": "win11-21h2-avd-m365"
      }
    },
    "$fxv#4": {
      "deploymentName": "secondary",
      "avd": {
        "hostPoolName": "marketing-designers-host-pool",
        "hostPoolFriendlyName": "Marketing Designers Host Pool",
        "appGroupName": "marketing-designers-app-group",
        "appGroupFriendlyName": "Marketing Designers Application Group",
        "workspaceName": "marketing-designers-workspace",
        "workspaceFriendlyName": "Marketing Designers Workspace",
        "appGroupType": "Desktop",
        "preferredAppGroupType": "Desktop",
        "hostPoolType": "pooled",
        "loadBalancerType": "BreadthFirst"
      },
      "sessionHosts": {
        "count": 1,
        "vmSize": "Standard_NV12s_v3",
        "namePrefix": "mkt-vm",
        "vmImageOffer": "Office-365",
        "vmImageSku": "win11-21h2-avd-m365"
      }
    },
    "$fxv#5": {
      "deploymentName": "tertiary",
      "avd": {
        "hostPoolName": "vip-host-pool",
        "hostPoolFriendlyName": "VIP Host Pool",
        "appGroupName": "vip-app-group",
        "appGroupFriendlyName": "VIP Application Group",
        "workspaceName": "vip-workspace",
        "workspaceFriendlyName": "VIP Workspace",
        "appGroupType": "Desktop",
        "preferredAppGroupType": "Desktop",
        "hostPoolType": "Personal",
        "loadBalancerType": ""
      },
      "sessionHosts": {
        "count": 1,
        "vmSize": "Standard_D2s_v5",
        "namePrefix": "vip-vm",
        "vmImageOffer": "Office-365",
        "vmImageSku": "win11-21h2-avd-m365"
      }
    },
    "$fxv#6": {
      "rg": {
        "name": "contoso-avd-rg",
        "location": "westus2"
      },
      "storage": {
        "accountName": "ubhitsavdstorageacc",
        "kind": "FileStorage",
        "redundancy": "Premium_LRS",
        "fileShareFolderName": "profiles"
      }
    },
    "$fxv#7": {
      "domain": "ubhims.com",
      "numUsers": 1,
      "groups": [
        {
          "name": "AAD DC Administrators",
          "userPrefix": "adadmin",
          "type": "adAdmin",
          "objectId": "41e33772-15c3-48de-bb48-d1edb64dcad2"
        },
        {
          "name": "UbhiMS AVD Admins",
          "userPrefix": "avdadmin",
          "type": "avdAdmin",
          "objectId": "aef8331c-ea85-47a9-843b-1bc59e111999"
        },
        {
          "name": "UbhiMS Developers",
          "userPrefix": "devuser",
          "type": "user",
          "objectId": "a3141c2a-6948-40d1-80c6-fe42c5f1ba4c"
        },
        {
          "name": "UbhiMS Marketing Designers",
          "userPrefix": "mktuser",
          "type": "user",
          "objectId": "b4c41875-956a-4046-8dee-944d50e1259c"
        },
        {
          "name": "UbhiMS VIP Users",
          "userPrefix": "vipuser",
          "type": "user",
          "objectId": "eb7eaa0e-d625-4a02-a47c-beec923f9545"
        }
      ],
      "adAdminUsername": "adadmin0@ubhims.com",
      "localVMAdminUsername": "vmadmin",
      "defaultPassword": "CoolBicep!1@2",
      "defaultEmail": "tubhi@microsoft.com"
    },
    "baseConfigPrimary": "[variables('$fxv#0')]",
    "baseConfigSecondary": "[variables('$fxv#1')]",
    "baseConfigTertiary": "[variables('$fxv#2')]",
    "configPrimary": "[variables('$fxv#3')]",
    "configSecondary": "[variables('$fxv#4')]",
    "configTertiary": "[variables('$fxv#5')]",
    "avdConfig": "[variables('$fxv#6')]",
    "domainConfig": "[variables('$fxv#7')]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "deploy-avd-rg",
      "subscriptionId": "[subscription().subscriptionId]",
      "location": "[resourceGroup().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "config": {
            "value": "[variables('avdConfig')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.9.1.41621",
              "templateHash": "4614197390158067111"
            }
          },
          "parameters": {
            "config": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-01-01",
              "name": "[parameters('config').rg.name]",
              "location": "[parameters('config').rg.location]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('config').rg.name)]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('config').rg.name]"
            },
            "location": {
              "type": "string",
              "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('config').rg.name), '2021-01-01', 'full').location]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "deploy-avd-storage",
      "resourceGroup": "[variables('avdConfig').rg.name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "config": {
            "value": "[variables('avdConfig')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.9.1.41621",
              "templateHash": "10635804259104343608"
            }
          },
          "parameters": {
            "config": {
              "type": "object"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2021-09-01",
              "name": "[parameters('config').storage.accountName]",
              "location": "[parameters('config').rg.location]",
              "kind": "[parameters('config').storage.kind]",
              "sku": {
                "name": "[parameters('config').storage.redundancy]"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2021-09-01",
              "name": "[format('{0}/default/{1}', parameters('config').storage.accountName, parameters('config').storage.fileShareFolderName)]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('config').storage.accountName)]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'deploy-avd-rg')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('deploy-avd-{0}', variables('configPrimary').deploymentName)]",
      "resourceGroup": "[variables('baseConfigPrimary').rg.name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseConfig": {
            "value": "[variables('baseConfigPrimary')]"
          },
          "domainConfig": {
            "value": "[variables('domainConfig')]"
          },
          "config": {
            "value": "[variables('configPrimary')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.9.1.41621",
              "templateHash": "18234362579929590605"
            }
          },
          "parameters": {
            "baseConfig": {
              "type": "object"
            },
            "domainConfig": {
              "type": "object"
            },
            "config": {
              "type": "object"
            },
            "currentUTCTime": {
              "type": "string",
              "defaultValue": "[utcNow('u')]"
            }
          },
          "variables": {
            "expirationTime": "[dateTimeAdd(parameters('currentUTCTime'), 'PT48H')]",
            "location": "[parameters('baseConfig').rg.location]"
          },
          "resources": [
            {
              "type": "Microsoft.DesktopVirtualization/hostPools",
              "apiVersion": "2022-04-01-preview",
              "name": "[parameters('config').avd.hostPoolName]",
              "location": "[variables('location')]",
              "properties": {
                "friendlyName": "[parameters('config').avd.hostPoolFriendlyName]",
                "hostPoolType": "[parameters('config').avd.hostPoolType]",
                "loadBalancerType": "[parameters('config').avd.loadBalancerType]",
                "preferredAppGroupType": "[parameters('config').avd.preferredAppGroupType]",
                "validationEnvironment": true,
                "customRdpProperty": "drivestoredirect:s:*;audiomode:i:0;videoplaybackmode:i:1;redirectclipboard:i:1;redirectprinters:i:1;devicestoredirect:s:*;redirectcomports:i:1;redirectsmartcards:i:1;usbdevicestoredirect:s:*;enablecredsspsupport:i:1;use multimon:i:1",
                "registrationInfo": {
                  "expirationTime": "[variables('expirationTime')]",
                  "registrationTokenOperation": "Update"
                }
              }
            },
            {
              "type": "Microsoft.DesktopVirtualization/applicationGroups",
              "apiVersion": "2022-04-01-preview",
              "name": "[parameters('config').avd.appGroupName]",
              "location": "[variables('location')]",
              "properties": {
                "friendlyName": "[parameters('config').avd.appGroupFriendlyName]",
                "applicationGroupType": "[parameters('config').avd.appGroupType]",
                "hostPoolArmPath": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('config').avd.hostPoolName)]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('config').avd.hostPoolName)]"
              ]
            },
            {
              "type": "Microsoft.DesktopVirtualization/workspaces",
              "apiVersion": "2022-04-01-preview",
              "name": "[parameters('config').avd.workspaceName]",
              "location": "[variables('location')]",
              "properties": {
                "friendlyName": "[parameters('config').avd.workspaceFriendlyName]",
                "applicationGroupReferences": [
                  "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('config').avd.appGroupName)]"
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('config').avd.appGroupName)]"
              ]
            },
            {
              "copy": {
                "name": "sessionHosts",
                "count": "[length(range(0, parameters('config').sessionHosts.count))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('deploy-{0}-{1}-{2}', parameters('config').avd.hostPoolName, parameters('config').sessionHosts.namePrefix, range(0, parameters('config').sessionHosts.count)[copyIndex()])]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "vNetName": {
                    "value": "[parameters('baseConfig').hub.name]"
                  },
                  "sNetName": {
                    "value": "[parameters('baseConfig').hub.subnets.dmzSubnet.name]"
                  },
                  "location": {
                    "value": "[variables('location')]"
                  },
                  "vmName": {
                    "value": "[format('{0}-{1}', parameters('config').sessionHosts.namePrefix, range(0, parameters('config').sessionHosts.count)[copyIndex()])]"
                  },
                  "vmSize": {
                    "value": "[parameters('config').sessionHosts.vmSize]"
                  },
                  "adminUsername": {
                    "value": "[parameters('domainConfig').localVMAdminUsername]"
                  },
                  "adminPassword": {
                    "value": "[parameters('domainConfig').defaultPassword]"
                  },
                  "vmImageOffer": {
                    "value": "[parameters('config').sessionHosts.vmImageOffer]"
                  },
                  "vmImageSku": {
                    "value": "[parameters('config').sessionHosts.vmImageSku]"
                  },
                  "networkJoin": {
                    "value": "AD"
                  },
                  "domainToJoin": {
                    "value": "[parameters('domainConfig').domain]"
                  },
                  "domainUserName": {
                    "value": "[parameters('domainConfig').adAdminUsername]"
                  },
                  "domainPassword": {
                    "value": "[parameters('domainConfig').defaultPassword]"
                  },
                  "hostPoolName": {
                    "value": "[parameters('config').avd.hostPoolName]"
                  },
                  "hostPoolRegToken": {
                    "value": "[reference(resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('config').avd.hostPoolName)).registrationInfo.token]"
                  },
                  "autoShutDownNoticeEmail": {
                    "value": "[parameters('domainConfig').defaultEmail]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.9.1.41621",
                      "templateHash": "9770700182679677124"
                    }
                  },
                  "parameters": {
                    "vmName": {
                      "type": "string",
                      "maxLength": 15
                    },
                    "location": {
                      "type": "string"
                    },
                    "vNetName": {
                      "type": "string"
                    },
                    "sNetName": {
                      "type": "string"
                    },
                    "vmSize": {
                      "type": "string",
                      "defaultValue": "Standard_D2s_v5",
                      "allowedValues": [
                        "Standard_B1s",
                        "Standard_B2s",
                        "Standard_B2ms",
                        "Standard_B4ms",
                        "Standard_D2s_v5",
                        "Standard_D4s_v5",
                        "Standard_NV12s_v3",
                        "Standard_NV32as_v4",
                        "Standard_NV36ads_A10_v5"
                      ]
                    },
                    "vmOSDiskStorageAccountType": {
                      "type": "string",
                      "defaultValue": "Premium_LRS",
                      "allowedValues": [
                        "Standard_LRS",
                        "StandardSSD_LRS",
                        "Premium_LRS"
                      ]
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "adminPassword": {
                      "type": "secureString",
                      "minLength": 12
                    },
                    "vmImagePublisher": {
                      "type": "string",
                      "defaultValue": "MicrosoftWindowsDesktop",
                      "allowedValues": [
                        "MicrosoftWindowsDesktop",
                        "MicrosoftWindowsServer"
                      ]
                    },
                    "vmImageOffer": {
                      "type": "string",
                      "defaultValue": "Office-365",
                      "allowedValues": [
                        "Windows-10",
                        "WindowsServer",
                        "Office-365"
                      ]
                    },
                    "vmImageSku": {
                      "type": "string",
                      "defaultValue": "win11-21h2-avd-m365",
                      "allowedValues": [
                        "2019-datacenter-gensecond",
                        "win10-21h2-pro",
                        "win11-21h2-avd-m365"
                      ]
                    },
                    "osAHBLicenseType": {
                      "type": "string",
                      "defaultValue": "Windows_Client",
                      "allowedValues": [
                        "Windows_Client",
                        "Windows_Server",
                        "RHEL_BYOS",
                        "SLES_BYOS"
                      ]
                    },
                    "autoShutDown": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "autoShutDownNoticeEmail": {
                      "type": "string"
                    },
                    "networkJoin": {
                      "type": "string",
                      "defaultValue": "None",
                      "allowedValues": [
                        "None",
                        "AD",
                        "AAD"
                      ]
                    },
                    "domainToJoin": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainJoinOptions": {
                      "type": "int",
                      "defaultValue": 3,
                      "metadata": {
                        "description": "Set of bit flags that define the join options. Default value of 3 is a combination of NETSETUP_JOIN_DOMAIN (0x00000001) & NETSETUP_ACCT_CREATE (0x00000002) i.e. will join the domain and create the account on the domain. For more information see https://msdn.microsoft.com/en-us/library/aa392154(v=vs.85).aspx"
                      }
                    },
                    "domainOUPath": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainUserName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainPassword": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "hostPoolName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "hostPoolRegToken": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "variables": {
                    "gpuNVIDIA": "[or(equals(parameters('vmSize'), 'Standard_NV12s_v3'), equals(parameters('vmSize'), 'Standard_NV36ads_A10_v5'))]",
                    "gpuAMD": "[equals(parameters('vmSize'), 'Standard_NV32as_v4')]",
                    "installAVDAgent": "[not(equals(parameters('hostPoolName'), ''))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}_nic', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "enableAcceleratedNetworking": true,
                        "enableIPForwarding": false,
                        "ipConfigurations": [
                          {
                            "name": "[format('{0}-nic-ipconfig1', parameters('vmName'))]",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vNetName'), parameters('sNetName'))]"
                              }
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2022-03-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "osDisk": {
                            "name": "[format('{0}_osdisk', parameters('vmName'))]",
                            "createOption": "FromImage",
                            "deleteOption": "Delete",
                            "managedDisk": {
                              "storageAccountType": "[parameters('vmOSDiskStorageAccountType')]"
                            }
                          },
                          "imageReference": {
                            "publisher": "[parameters('vmImagePublisher')]",
                            "offer": "[parameters('vmImageOffer')]",
                            "sku": "[parameters('vmImageSku')]",
                            "version": "latest"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}_nic', parameters('vmName')))]",
                              "properties": {
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPassword')]",
                          "windowsConfiguration": {
                            "enableAutomaticUpdates": true,
                            "provisionVMAgent": true,
                            "patchSettings": {
                              "enableHotpatching": false,
                              "patchMode": "AutomaticByOS"
                            }
                          }
                        },
                        "licenseType": "[parameters('osAHBLicenseType')]"
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}_nic', parameters('vmName')))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('networkJoin'), 'AD')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/JoinDomain', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "JsonADDomainExtension",
                        "typeHandlerVersion": "1.3",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "name": "[parameters('domainToJoin')]",
                          "ouPath": "[parameters('domainOUPath')]",
                          "user": "[parameters('domainUserName')]",
                          "options": "[parameters('domainJoinOptions')]",
                          "restart": true
                        },
                        "protectedSettings": {
                          "password": "[parameters('domainPassword')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('networkJoin'), 'AAD')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/AADLoginForWindows', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.ActiveDirectory",
                        "type": "AADLoginForWindows",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[variables('gpuNVIDIA')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'NvidiaGpuDriverWindows')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.HpcCompute",
                        "type": "NvidiaGpuDriverWindows",
                        "typeHandlerVersion": "1.4",
                        "autoUpgradeMinorVersion": true,
                        "settings": {}
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/AADLoginForWindows', parameters('vmName')), '/')[0], split(format('{0}/AADLoginForWindows', parameters('vmName')), '/')[1])]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/JoinDomain', parameters('vmName')), '/')[0], split(format('{0}/JoinDomain', parameters('vmName')), '/')[1])]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[variables('gpuAMD')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'AmdGpuDriverWindows')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.HpcCompute",
                        "type": "AmdGpuDriverWindows",
                        "typeHandlerVersion": "1.1",
                        "autoUpgradeMinorVersion": true,
                        "settings": {}
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/AADLoginForWindows', parameters('vmName')), '/')[0], split(format('{0}/AADLoginForWindows', parameters('vmName')), '/')[1])]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/JoinDomain', parameters('vmName')), '/')[0], split(format('{0}/JoinDomain', parameters('vmName')), '/')[1])]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'enable-ping-icmp-v4')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "source": {
                          "script": "netsh advfirewall firewall add rule name=\"ICMPv4 Echo (Ping)\" protocol=\"icmpv4:8,any\" dir=in action=allow"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AmdGpuDriverWindows')]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'NvidiaGpuDriverWindows')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'enable-ping-icmp-v6')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "source": {
                          "script": "netsh advfirewall firewall add rule name=\"ICMPv6 Echo (Ping)\" protocol=\"icmpv6:8,any\" dir=in action=allow"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AmdGpuDriverWindows')]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'NvidiaGpuDriverWindows')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('autoShutDown')]",
                      "type": "Microsoft.DevTestLab/schedules",
                      "apiVersion": "2018-09-15",
                      "name": "[format('shutdown-computevm-{0}', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "status": "Enabled",
                        "taskType": "ComputeVmShutdownTask",
                        "dailyRecurrence": {
                          "time": "04:00"
                        },
                        "timeZoneId": "Pacific Standard Time",
                        "targetResourceId": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]",
                        "notificationSettings": {
                          "status": "Enabled",
                          "notificationLocale": "en",
                          "timeInMinutes": 30,
                          "emailRecipient": "[parameters('autoShutDownNoticeEmail')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('vmName'), 'enable-ping-icmp-v4')]",
                        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('vmName'), 'enable-ping-icmp-v6')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[variables('installAVDAgent')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/AddSessionHost', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.Powershell",
                        "type": "DSC",
                        "typeHandlerVersion": "2.73",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "modulesUrl": "https://wvdportalstorageblob.blob.core.windows.net/galleryartifacts/Configuration_08-10-2022.zip",
                          "configurationFunction": "Configuration.ps1\\AddSessionHost",
                          "properties": {
                            "hostPoolName": "[parameters('hostPoolName')]",
                            "registrationInfoToken": "[parameters('hostPoolRegToken')]",
                            "aadJoin": "[equals(parameters('networkJoin'), 'AAD')]",
                            "UseAgentDownloadEndpoint": true
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DevTestLab/schedules', format('shutdown-computevm-{0}', parameters('vmName')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('vmName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('config').avd.hostPoolName)]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('avdConfig').rg.name), 'Microsoft.Resources/deployments', 'deploy-avd-storage')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('deploy-avd-{0}', variables('configSecondary').deploymentName)]",
      "resourceGroup": "[variables('baseConfigSecondary').rg.name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseConfig": {
            "value": "[variables('baseConfigSecondary')]"
          },
          "domainConfig": {
            "value": "[variables('domainConfig')]"
          },
          "config": {
            "value": "[variables('configSecondary')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.9.1.41621",
              "templateHash": "18234362579929590605"
            }
          },
          "parameters": {
            "baseConfig": {
              "type": "object"
            },
            "domainConfig": {
              "type": "object"
            },
            "config": {
              "type": "object"
            },
            "currentUTCTime": {
              "type": "string",
              "defaultValue": "[utcNow('u')]"
            }
          },
          "variables": {
            "expirationTime": "[dateTimeAdd(parameters('currentUTCTime'), 'PT48H')]",
            "location": "[parameters('baseConfig').rg.location]"
          },
          "resources": [
            {
              "type": "Microsoft.DesktopVirtualization/hostPools",
              "apiVersion": "2022-04-01-preview",
              "name": "[parameters('config').avd.hostPoolName]",
              "location": "[variables('location')]",
              "properties": {
                "friendlyName": "[parameters('config').avd.hostPoolFriendlyName]",
                "hostPoolType": "[parameters('config').avd.hostPoolType]",
                "loadBalancerType": "[parameters('config').avd.loadBalancerType]",
                "preferredAppGroupType": "[parameters('config').avd.preferredAppGroupType]",
                "validationEnvironment": true,
                "customRdpProperty": "drivestoredirect:s:*;audiomode:i:0;videoplaybackmode:i:1;redirectclipboard:i:1;redirectprinters:i:1;devicestoredirect:s:*;redirectcomports:i:1;redirectsmartcards:i:1;usbdevicestoredirect:s:*;enablecredsspsupport:i:1;use multimon:i:1",
                "registrationInfo": {
                  "expirationTime": "[variables('expirationTime')]",
                  "registrationTokenOperation": "Update"
                }
              }
            },
            {
              "type": "Microsoft.DesktopVirtualization/applicationGroups",
              "apiVersion": "2022-04-01-preview",
              "name": "[parameters('config').avd.appGroupName]",
              "location": "[variables('location')]",
              "properties": {
                "friendlyName": "[parameters('config').avd.appGroupFriendlyName]",
                "applicationGroupType": "[parameters('config').avd.appGroupType]",
                "hostPoolArmPath": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('config').avd.hostPoolName)]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('config').avd.hostPoolName)]"
              ]
            },
            {
              "type": "Microsoft.DesktopVirtualization/workspaces",
              "apiVersion": "2022-04-01-preview",
              "name": "[parameters('config').avd.workspaceName]",
              "location": "[variables('location')]",
              "properties": {
                "friendlyName": "[parameters('config').avd.workspaceFriendlyName]",
                "applicationGroupReferences": [
                  "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('config').avd.appGroupName)]"
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('config').avd.appGroupName)]"
              ]
            },
            {
              "copy": {
                "name": "sessionHosts",
                "count": "[length(range(0, parameters('config').sessionHosts.count))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('deploy-{0}-{1}-{2}', parameters('config').avd.hostPoolName, parameters('config').sessionHosts.namePrefix, range(0, parameters('config').sessionHosts.count)[copyIndex()])]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "vNetName": {
                    "value": "[parameters('baseConfig').hub.name]"
                  },
                  "sNetName": {
                    "value": "[parameters('baseConfig').hub.subnets.dmzSubnet.name]"
                  },
                  "location": {
                    "value": "[variables('location')]"
                  },
                  "vmName": {
                    "value": "[format('{0}-{1}', parameters('config').sessionHosts.namePrefix, range(0, parameters('config').sessionHosts.count)[copyIndex()])]"
                  },
                  "vmSize": {
                    "value": "[parameters('config').sessionHosts.vmSize]"
                  },
                  "adminUsername": {
                    "value": "[parameters('domainConfig').localVMAdminUsername]"
                  },
                  "adminPassword": {
                    "value": "[parameters('domainConfig').defaultPassword]"
                  },
                  "vmImageOffer": {
                    "value": "[parameters('config').sessionHosts.vmImageOffer]"
                  },
                  "vmImageSku": {
                    "value": "[parameters('config').sessionHosts.vmImageSku]"
                  },
                  "networkJoin": {
                    "value": "AD"
                  },
                  "domainToJoin": {
                    "value": "[parameters('domainConfig').domain]"
                  },
                  "domainUserName": {
                    "value": "[parameters('domainConfig').adAdminUsername]"
                  },
                  "domainPassword": {
                    "value": "[parameters('domainConfig').defaultPassword]"
                  },
                  "hostPoolName": {
                    "value": "[parameters('config').avd.hostPoolName]"
                  },
                  "hostPoolRegToken": {
                    "value": "[reference(resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('config').avd.hostPoolName)).registrationInfo.token]"
                  },
                  "autoShutDownNoticeEmail": {
                    "value": "[parameters('domainConfig').defaultEmail]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.9.1.41621",
                      "templateHash": "9770700182679677124"
                    }
                  },
                  "parameters": {
                    "vmName": {
                      "type": "string",
                      "maxLength": 15
                    },
                    "location": {
                      "type": "string"
                    },
                    "vNetName": {
                      "type": "string"
                    },
                    "sNetName": {
                      "type": "string"
                    },
                    "vmSize": {
                      "type": "string",
                      "defaultValue": "Standard_D2s_v5",
                      "allowedValues": [
                        "Standard_B1s",
                        "Standard_B2s",
                        "Standard_B2ms",
                        "Standard_B4ms",
                        "Standard_D2s_v5",
                        "Standard_D4s_v5",
                        "Standard_NV12s_v3",
                        "Standard_NV32as_v4",
                        "Standard_NV36ads_A10_v5"
                      ]
                    },
                    "vmOSDiskStorageAccountType": {
                      "type": "string",
                      "defaultValue": "Premium_LRS",
                      "allowedValues": [
                        "Standard_LRS",
                        "StandardSSD_LRS",
                        "Premium_LRS"
                      ]
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "adminPassword": {
                      "type": "secureString",
                      "minLength": 12
                    },
                    "vmImagePublisher": {
                      "type": "string",
                      "defaultValue": "MicrosoftWindowsDesktop",
                      "allowedValues": [
                        "MicrosoftWindowsDesktop",
                        "MicrosoftWindowsServer"
                      ]
                    },
                    "vmImageOffer": {
                      "type": "string",
                      "defaultValue": "Office-365",
                      "allowedValues": [
                        "Windows-10",
                        "WindowsServer",
                        "Office-365"
                      ]
                    },
                    "vmImageSku": {
                      "type": "string",
                      "defaultValue": "win11-21h2-avd-m365",
                      "allowedValues": [
                        "2019-datacenter-gensecond",
                        "win10-21h2-pro",
                        "win11-21h2-avd-m365"
                      ]
                    },
                    "osAHBLicenseType": {
                      "type": "string",
                      "defaultValue": "Windows_Client",
                      "allowedValues": [
                        "Windows_Client",
                        "Windows_Server",
                        "RHEL_BYOS",
                        "SLES_BYOS"
                      ]
                    },
                    "autoShutDown": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "autoShutDownNoticeEmail": {
                      "type": "string"
                    },
                    "networkJoin": {
                      "type": "string",
                      "defaultValue": "None",
                      "allowedValues": [
                        "None",
                        "AD",
                        "AAD"
                      ]
                    },
                    "domainToJoin": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainJoinOptions": {
                      "type": "int",
                      "defaultValue": 3,
                      "metadata": {
                        "description": "Set of bit flags that define the join options. Default value of 3 is a combination of NETSETUP_JOIN_DOMAIN (0x00000001) & NETSETUP_ACCT_CREATE (0x00000002) i.e. will join the domain and create the account on the domain. For more information see https://msdn.microsoft.com/en-us/library/aa392154(v=vs.85).aspx"
                      }
                    },
                    "domainOUPath": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainUserName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainPassword": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "hostPoolName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "hostPoolRegToken": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "variables": {
                    "gpuNVIDIA": "[or(equals(parameters('vmSize'), 'Standard_NV12s_v3'), equals(parameters('vmSize'), 'Standard_NV36ads_A10_v5'))]",
                    "gpuAMD": "[equals(parameters('vmSize'), 'Standard_NV32as_v4')]",
                    "installAVDAgent": "[not(equals(parameters('hostPoolName'), ''))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}_nic', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "enableAcceleratedNetworking": true,
                        "enableIPForwarding": false,
                        "ipConfigurations": [
                          {
                            "name": "[format('{0}-nic-ipconfig1', parameters('vmName'))]",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vNetName'), parameters('sNetName'))]"
                              }
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2022-03-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "osDisk": {
                            "name": "[format('{0}_osdisk', parameters('vmName'))]",
                            "createOption": "FromImage",
                            "deleteOption": "Delete",
                            "managedDisk": {
                              "storageAccountType": "[parameters('vmOSDiskStorageAccountType')]"
                            }
                          },
                          "imageReference": {
                            "publisher": "[parameters('vmImagePublisher')]",
                            "offer": "[parameters('vmImageOffer')]",
                            "sku": "[parameters('vmImageSku')]",
                            "version": "latest"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}_nic', parameters('vmName')))]",
                              "properties": {
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPassword')]",
                          "windowsConfiguration": {
                            "enableAutomaticUpdates": true,
                            "provisionVMAgent": true,
                            "patchSettings": {
                              "enableHotpatching": false,
                              "patchMode": "AutomaticByOS"
                            }
                          }
                        },
                        "licenseType": "[parameters('osAHBLicenseType')]"
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}_nic', parameters('vmName')))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('networkJoin'), 'AD')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/JoinDomain', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "JsonADDomainExtension",
                        "typeHandlerVersion": "1.3",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "name": "[parameters('domainToJoin')]",
                          "ouPath": "[parameters('domainOUPath')]",
                          "user": "[parameters('domainUserName')]",
                          "options": "[parameters('domainJoinOptions')]",
                          "restart": true
                        },
                        "protectedSettings": {
                          "password": "[parameters('domainPassword')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('networkJoin'), 'AAD')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/AADLoginForWindows', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.ActiveDirectory",
                        "type": "AADLoginForWindows",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[variables('gpuNVIDIA')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'NvidiaGpuDriverWindows')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.HpcCompute",
                        "type": "NvidiaGpuDriverWindows",
                        "typeHandlerVersion": "1.4",
                        "autoUpgradeMinorVersion": true,
                        "settings": {}
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/AADLoginForWindows', parameters('vmName')), '/')[0], split(format('{0}/AADLoginForWindows', parameters('vmName')), '/')[1])]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/JoinDomain', parameters('vmName')), '/')[0], split(format('{0}/JoinDomain', parameters('vmName')), '/')[1])]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[variables('gpuAMD')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'AmdGpuDriverWindows')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.HpcCompute",
                        "type": "AmdGpuDriverWindows",
                        "typeHandlerVersion": "1.1",
                        "autoUpgradeMinorVersion": true,
                        "settings": {}
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/AADLoginForWindows', parameters('vmName')), '/')[0], split(format('{0}/AADLoginForWindows', parameters('vmName')), '/')[1])]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/JoinDomain', parameters('vmName')), '/')[0], split(format('{0}/JoinDomain', parameters('vmName')), '/')[1])]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'enable-ping-icmp-v4')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "source": {
                          "script": "netsh advfirewall firewall add rule name=\"ICMPv4 Echo (Ping)\" protocol=\"icmpv4:8,any\" dir=in action=allow"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AmdGpuDriverWindows')]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'NvidiaGpuDriverWindows')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'enable-ping-icmp-v6')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "source": {
                          "script": "netsh advfirewall firewall add rule name=\"ICMPv6 Echo (Ping)\" protocol=\"icmpv6:8,any\" dir=in action=allow"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AmdGpuDriverWindows')]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'NvidiaGpuDriverWindows')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('autoShutDown')]",
                      "type": "Microsoft.DevTestLab/schedules",
                      "apiVersion": "2018-09-15",
                      "name": "[format('shutdown-computevm-{0}', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "status": "Enabled",
                        "taskType": "ComputeVmShutdownTask",
                        "dailyRecurrence": {
                          "time": "04:00"
                        },
                        "timeZoneId": "Pacific Standard Time",
                        "targetResourceId": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]",
                        "notificationSettings": {
                          "status": "Enabled",
                          "notificationLocale": "en",
                          "timeInMinutes": 30,
                          "emailRecipient": "[parameters('autoShutDownNoticeEmail')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('vmName'), 'enable-ping-icmp-v4')]",
                        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('vmName'), 'enable-ping-icmp-v6')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[variables('installAVDAgent')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/AddSessionHost', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.Powershell",
                        "type": "DSC",
                        "typeHandlerVersion": "2.73",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "modulesUrl": "https://wvdportalstorageblob.blob.core.windows.net/galleryartifacts/Configuration_08-10-2022.zip",
                          "configurationFunction": "Configuration.ps1\\AddSessionHost",
                          "properties": {
                            "hostPoolName": "[parameters('hostPoolName')]",
                            "registrationInfoToken": "[parameters('hostPoolRegToken')]",
                            "aadJoin": "[equals(parameters('networkJoin'), 'AAD')]",
                            "UseAgentDownloadEndpoint": true
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DevTestLab/schedules', format('shutdown-computevm-{0}', parameters('vmName')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('vmName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('config').avd.hostPoolName)]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('avdConfig').rg.name), 'Microsoft.Resources/deployments', 'deploy-avd-storage')]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('deploy-avd-{0}', variables('configTertiary').deploymentName)]",
      "resourceGroup": "[variables('baseConfigTertiary').rg.name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "baseConfig": {
            "value": "[variables('baseConfigTertiary')]"
          },
          "domainConfig": {
            "value": "[variables('domainConfig')]"
          },
          "config": {
            "value": "[variables('configTertiary')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.9.1.41621",
              "templateHash": "18234362579929590605"
            }
          },
          "parameters": {
            "baseConfig": {
              "type": "object"
            },
            "domainConfig": {
              "type": "object"
            },
            "config": {
              "type": "object"
            },
            "currentUTCTime": {
              "type": "string",
              "defaultValue": "[utcNow('u')]"
            }
          },
          "variables": {
            "expirationTime": "[dateTimeAdd(parameters('currentUTCTime'), 'PT48H')]",
            "location": "[parameters('baseConfig').rg.location]"
          },
          "resources": [
            {
              "type": "Microsoft.DesktopVirtualization/hostPools",
              "apiVersion": "2022-04-01-preview",
              "name": "[parameters('config').avd.hostPoolName]",
              "location": "[variables('location')]",
              "properties": {
                "friendlyName": "[parameters('config').avd.hostPoolFriendlyName]",
                "hostPoolType": "[parameters('config').avd.hostPoolType]",
                "loadBalancerType": "[parameters('config').avd.loadBalancerType]",
                "preferredAppGroupType": "[parameters('config').avd.preferredAppGroupType]",
                "validationEnvironment": true,
                "customRdpProperty": "drivestoredirect:s:*;audiomode:i:0;videoplaybackmode:i:1;redirectclipboard:i:1;redirectprinters:i:1;devicestoredirect:s:*;redirectcomports:i:1;redirectsmartcards:i:1;usbdevicestoredirect:s:*;enablecredsspsupport:i:1;use multimon:i:1",
                "registrationInfo": {
                  "expirationTime": "[variables('expirationTime')]",
                  "registrationTokenOperation": "Update"
                }
              }
            },
            {
              "type": "Microsoft.DesktopVirtualization/applicationGroups",
              "apiVersion": "2022-04-01-preview",
              "name": "[parameters('config').avd.appGroupName]",
              "location": "[variables('location')]",
              "properties": {
                "friendlyName": "[parameters('config').avd.appGroupFriendlyName]",
                "applicationGroupType": "[parameters('config').avd.appGroupType]",
                "hostPoolArmPath": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('config').avd.hostPoolName)]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('config').avd.hostPoolName)]"
              ]
            },
            {
              "type": "Microsoft.DesktopVirtualization/workspaces",
              "apiVersion": "2022-04-01-preview",
              "name": "[parameters('config').avd.workspaceName]",
              "location": "[variables('location')]",
              "properties": {
                "friendlyName": "[parameters('config').avd.workspaceFriendlyName]",
                "applicationGroupReferences": [
                  "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('config').avd.appGroupName)]"
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('config').avd.appGroupName)]"
              ]
            },
            {
              "copy": {
                "name": "sessionHosts",
                "count": "[length(range(0, parameters('config').sessionHosts.count))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('deploy-{0}-{1}-{2}', parameters('config').avd.hostPoolName, parameters('config').sessionHosts.namePrefix, range(0, parameters('config').sessionHosts.count)[copyIndex()])]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "vNetName": {
                    "value": "[parameters('baseConfig').hub.name]"
                  },
                  "sNetName": {
                    "value": "[parameters('baseConfig').hub.subnets.dmzSubnet.name]"
                  },
                  "location": {
                    "value": "[variables('location')]"
                  },
                  "vmName": {
                    "value": "[format('{0}-{1}', parameters('config').sessionHosts.namePrefix, range(0, parameters('config').sessionHosts.count)[copyIndex()])]"
                  },
                  "vmSize": {
                    "value": "[parameters('config').sessionHosts.vmSize]"
                  },
                  "adminUsername": {
                    "value": "[parameters('domainConfig').localVMAdminUsername]"
                  },
                  "adminPassword": {
                    "value": "[parameters('domainConfig').defaultPassword]"
                  },
                  "vmImageOffer": {
                    "value": "[parameters('config').sessionHosts.vmImageOffer]"
                  },
                  "vmImageSku": {
                    "value": "[parameters('config').sessionHosts.vmImageSku]"
                  },
                  "networkJoin": {
                    "value": "AD"
                  },
                  "domainToJoin": {
                    "value": "[parameters('domainConfig').domain]"
                  },
                  "domainUserName": {
                    "value": "[parameters('domainConfig').adAdminUsername]"
                  },
                  "domainPassword": {
                    "value": "[parameters('domainConfig').defaultPassword]"
                  },
                  "hostPoolName": {
                    "value": "[parameters('config').avd.hostPoolName]"
                  },
                  "hostPoolRegToken": {
                    "value": "[reference(resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('config').avd.hostPoolName)).registrationInfo.token]"
                  },
                  "autoShutDownNoticeEmail": {
                    "value": "[parameters('domainConfig').defaultEmail]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.9.1.41621",
                      "templateHash": "9770700182679677124"
                    }
                  },
                  "parameters": {
                    "vmName": {
                      "type": "string",
                      "maxLength": 15
                    },
                    "location": {
                      "type": "string"
                    },
                    "vNetName": {
                      "type": "string"
                    },
                    "sNetName": {
                      "type": "string"
                    },
                    "vmSize": {
                      "type": "string",
                      "defaultValue": "Standard_D2s_v5",
                      "allowedValues": [
                        "Standard_B1s",
                        "Standard_B2s",
                        "Standard_B2ms",
                        "Standard_B4ms",
                        "Standard_D2s_v5",
                        "Standard_D4s_v5",
                        "Standard_NV12s_v3",
                        "Standard_NV32as_v4",
                        "Standard_NV36ads_A10_v5"
                      ]
                    },
                    "vmOSDiskStorageAccountType": {
                      "type": "string",
                      "defaultValue": "Premium_LRS",
                      "allowedValues": [
                        "Standard_LRS",
                        "StandardSSD_LRS",
                        "Premium_LRS"
                      ]
                    },
                    "adminUsername": {
                      "type": "string"
                    },
                    "adminPassword": {
                      "type": "secureString",
                      "minLength": 12
                    },
                    "vmImagePublisher": {
                      "type": "string",
                      "defaultValue": "MicrosoftWindowsDesktop",
                      "allowedValues": [
                        "MicrosoftWindowsDesktop",
                        "MicrosoftWindowsServer"
                      ]
                    },
                    "vmImageOffer": {
                      "type": "string",
                      "defaultValue": "Office-365",
                      "allowedValues": [
                        "Windows-10",
                        "WindowsServer",
                        "Office-365"
                      ]
                    },
                    "vmImageSku": {
                      "type": "string",
                      "defaultValue": "win11-21h2-avd-m365",
                      "allowedValues": [
                        "2019-datacenter-gensecond",
                        "win10-21h2-pro",
                        "win11-21h2-avd-m365"
                      ]
                    },
                    "osAHBLicenseType": {
                      "type": "string",
                      "defaultValue": "Windows_Client",
                      "allowedValues": [
                        "Windows_Client",
                        "Windows_Server",
                        "RHEL_BYOS",
                        "SLES_BYOS"
                      ]
                    },
                    "autoShutDown": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "autoShutDownNoticeEmail": {
                      "type": "string"
                    },
                    "networkJoin": {
                      "type": "string",
                      "defaultValue": "None",
                      "allowedValues": [
                        "None",
                        "AD",
                        "AAD"
                      ]
                    },
                    "domainToJoin": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainJoinOptions": {
                      "type": "int",
                      "defaultValue": 3,
                      "metadata": {
                        "description": "Set of bit flags that define the join options. Default value of 3 is a combination of NETSETUP_JOIN_DOMAIN (0x00000001) & NETSETUP_ACCT_CREATE (0x00000002) i.e. will join the domain and create the account on the domain. For more information see https://msdn.microsoft.com/en-us/library/aa392154(v=vs.85).aspx"
                      }
                    },
                    "domainOUPath": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainUserName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "domainPassword": {
                      "type": "secureString",
                      "defaultValue": ""
                    },
                    "hostPoolName": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "hostPoolRegToken": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "variables": {
                    "gpuNVIDIA": "[or(equals(parameters('vmSize'), 'Standard_NV12s_v3'), equals(parameters('vmSize'), 'Standard_NV36ads_A10_v5'))]",
                    "gpuAMD": "[equals(parameters('vmSize'), 'Standard_NV32as_v4')]",
                    "installAVDAgent": "[not(equals(parameters('hostPoolName'), ''))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}_nic', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "enableAcceleratedNetworking": true,
                        "enableIPForwarding": false,
                        "ipConfigurations": [
                          {
                            "name": "[format('{0}-nic-ipconfig1', parameters('vmName'))]",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('vNetName'), parameters('sNetName'))]"
                              }
                            }
                          }
                        ]
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2022-03-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "storageProfile": {
                          "osDisk": {
                            "name": "[format('{0}_osdisk', parameters('vmName'))]",
                            "createOption": "FromImage",
                            "deleteOption": "Delete",
                            "managedDisk": {
                              "storageAccountType": "[parameters('vmOSDiskStorageAccountType')]"
                            }
                          },
                          "imageReference": {
                            "publisher": "[parameters('vmImagePublisher')]",
                            "offer": "[parameters('vmImageOffer')]",
                            "sku": "[parameters('vmImageSku')]",
                            "version": "latest"
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('{0}_nic', parameters('vmName')))]",
                              "properties": {
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPassword')]",
                          "windowsConfiguration": {
                            "enableAutomaticUpdates": true,
                            "provisionVMAgent": true,
                            "patchSettings": {
                              "enableHotpatching": false,
                              "patchMode": "AutomaticByOS"
                            }
                          }
                        },
                        "licenseType": "[parameters('osAHBLicenseType')]"
                      },
                      "identity": {
                        "type": "SystemAssigned"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('{0}_nic', parameters('vmName')))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('networkJoin'), 'AD')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/JoinDomain', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "JsonADDomainExtension",
                        "typeHandlerVersion": "1.3",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "name": "[parameters('domainToJoin')]",
                          "ouPath": "[parameters('domainOUPath')]",
                          "user": "[parameters('domainUserName')]",
                          "options": "[parameters('domainJoinOptions')]",
                          "restart": true
                        },
                        "protectedSettings": {
                          "password": "[parameters('domainPassword')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[equals(parameters('networkJoin'), 'AAD')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2020-06-01",
                      "name": "[format('{0}/AADLoginForWindows', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.ActiveDirectory",
                        "type": "AADLoginForWindows",
                        "typeHandlerVersion": "1.0",
                        "autoUpgradeMinorVersion": true
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[variables('gpuNVIDIA')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'NvidiaGpuDriverWindows')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.HpcCompute",
                        "type": "NvidiaGpuDriverWindows",
                        "typeHandlerVersion": "1.4",
                        "autoUpgradeMinorVersion": true,
                        "settings": {}
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/AADLoginForWindows', parameters('vmName')), '/')[0], split(format('{0}/AADLoginForWindows', parameters('vmName')), '/')[1])]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/JoinDomain', parameters('vmName')), '/')[0], split(format('{0}/JoinDomain', parameters('vmName')), '/')[1])]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[variables('gpuAMD')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'AmdGpuDriverWindows')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.HpcCompute",
                        "type": "AmdGpuDriverWindows",
                        "typeHandlerVersion": "1.1",
                        "autoUpgradeMinorVersion": true,
                        "settings": {}
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/AADLoginForWindows', parameters('vmName')), '/')[0], split(format('{0}/AADLoginForWindows', parameters('vmName')), '/')[1])]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', split(format('{0}/JoinDomain', parameters('vmName')), '/')[0], split(format('{0}/JoinDomain', parameters('vmName')), '/')[1])]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'enable-ping-icmp-v4')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "source": {
                          "script": "netsh advfirewall firewall add rule name=\"ICMPv4 Echo (Ping)\" protocol=\"icmpv4:8,any\" dir=in action=allow"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AmdGpuDriverWindows')]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'NvidiaGpuDriverWindows')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/runCommands",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'enable-ping-icmp-v6')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "source": {
                          "script": "netsh advfirewall firewall add rule name=\"ICMPv6 Echo (Ping)\" protocol=\"icmpv6:8,any\" dir=in action=allow"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'AmdGpuDriverWindows')]",
                        "[resourceId('Microsoft.Compute/virtualMachines/extensions', parameters('vmName'), 'NvidiaGpuDriverWindows')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[parameters('autoShutDown')]",
                      "type": "Microsoft.DevTestLab/schedules",
                      "apiVersion": "2018-09-15",
                      "name": "[format('shutdown-computevm-{0}', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "status": "Enabled",
                        "taskType": "ComputeVmShutdownTask",
                        "dailyRecurrence": {
                          "time": "04:00"
                        },
                        "timeZoneId": "Pacific Standard Time",
                        "targetResourceId": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]",
                        "notificationSettings": {
                          "status": "Enabled",
                          "notificationLocale": "en",
                          "timeInMinutes": 30,
                          "emailRecipient": "[parameters('autoShutDownNoticeEmail')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('vmName'), 'enable-ping-icmp-v4')]",
                        "[resourceId('Microsoft.Compute/virtualMachines/runCommands', parameters('vmName'), 'enable-ping-icmp-v6')]",
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "condition": "[variables('installAVDAgent')]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2022-03-01",
                      "name": "[format('{0}/AddSessionHost', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.Powershell",
                        "type": "DSC",
                        "typeHandlerVersion": "2.73",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "modulesUrl": "https://wvdportalstorageblob.blob.core.windows.net/galleryartifacts/Configuration_08-10-2022.zip",
                          "configurationFunction": "Configuration.ps1\\AddSessionHost",
                          "properties": {
                            "hostPoolName": "[parameters('hostPoolName')]",
                            "registrationInfoToken": "[parameters('hostPoolRegToken')]",
                            "aadJoin": "[equals(parameters('networkJoin'), 'AAD')]",
                            "UseAgentDownloadEndpoint": true
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.DevTestLab/schedules', format('shutdown-computevm-{0}', parameters('vmName')))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "id": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                    },
                    "name": {
                      "type": "string",
                      "value": "[parameters('vmName')]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('config').avd.hostPoolName)]"
              ]
            }
          ]
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('avdConfig').rg.name), 'Microsoft.Resources/deployments', 'deploy-avd-storage')]"
      ]
    },
    {
      "condition": "[or(equals(variables('domainConfig').groups[copyIndex()].type, 'avdAdmin'), equals(variables('domainConfig').groups[copyIndex()].type, 'user'))]",
      "copy": {
        "name": "vmLoginRolesAssignmentPrimary",
        "count": "[length(variables('domainConfig').groups)]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('assign-vm-login-role-{0}-on-{1}', variables('domainConfig').groups[copyIndex()].userPrefix, variables('baseConfigPrimary').rg.name)]",
      "resourceGroup": "[variables('baseConfigPrimary').rg.name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adGroupId": {
            "value": "[variables('domainConfig').groups[copyIndex()].objectId]"
          },
          "isAdmin": {
            "value": "[equals(variables('domainConfig').groups[copyIndex()].type, 'avdAdmin')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.9.1.41621",
              "templateHash": "16863817949617688466"
            }
          },
          "parameters": {
            "adGroupId": {
              "type": "string"
            },
            "isAdmin": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "roles": {
              "Virtual Machine Administrator Login": "/providers/Microsoft.Authorization/roleDefinitions/1c0163c0-47e6-4577-8991-ea5c82e286e4",
              "Virtual Machine User Login": "/providers/Microsoft.Authorization/roleDefinitions/fb879df8-f326-4884-b1cf-06f3ad86be52"
            },
            "roleDefinitionId": "[if(parameters('isAdmin'), variables('roles')['Virtual Machine Administrator Login'], variables('roles')['Virtual Machine User Login'])]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, resourceGroup().id, parameters('adGroupId'), variables('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[variables('roleDefinitionId')]",
                "principalId": "[parameters('adGroupId')]",
                "principalType": "Group"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'deploy-avd-rg')]"
      ]
    },
    {
      "condition": "[or(equals(variables('domainConfig').groups[copyIndex()].type, 'avdAdmin'), equals(variables('domainConfig').groups[copyIndex()].type, 'user'))]",
      "copy": {
        "name": "vmLoginRolesAssignmentSecondary",
        "count": "[length(variables('domainConfig').groups)]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('assign-vm-login-role-{0}-on-{1}', variables('domainConfig').groups[copyIndex()].userPrefix, variables('baseConfigSecondary').rg.name)]",
      "resourceGroup": "[variables('baseConfigSecondary').rg.name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adGroupId": {
            "value": "[variables('domainConfig').groups[copyIndex()].objectId]"
          },
          "isAdmin": {
            "value": "[equals(variables('domainConfig').groups[copyIndex()].type, 'avdAdmin')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.9.1.41621",
              "templateHash": "16863817949617688466"
            }
          },
          "parameters": {
            "adGroupId": {
              "type": "string"
            },
            "isAdmin": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "roles": {
              "Virtual Machine Administrator Login": "/providers/Microsoft.Authorization/roleDefinitions/1c0163c0-47e6-4577-8991-ea5c82e286e4",
              "Virtual Machine User Login": "/providers/Microsoft.Authorization/roleDefinitions/fb879df8-f326-4884-b1cf-06f3ad86be52"
            },
            "roleDefinitionId": "[if(parameters('isAdmin'), variables('roles')['Virtual Machine Administrator Login'], variables('roles')['Virtual Machine User Login'])]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, resourceGroup().id, parameters('adGroupId'), variables('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[variables('roleDefinitionId')]",
                "principalId": "[parameters('adGroupId')]",
                "principalType": "Group"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'deploy-avd-rg')]"
      ]
    },
    {
      "condition": "[or(equals(variables('domainConfig').groups[copyIndex()].type, 'avdAdmin'), equals(variables('domainConfig').groups[copyIndex()].type, 'user'))]",
      "copy": {
        "name": "vmLoginRolesAssignmentTertiary",
        "count": "[length(variables('domainConfig').groups)]"
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('assign-vm-login-role-{0}-on-{1}', variables('domainConfig').groups[copyIndex()].userPrefix, variables('baseConfigTertiary').rg.name)]",
      "resourceGroup": "[variables('baseConfigTertiary').rg.name]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adGroupId": {
            "value": "[variables('domainConfig').groups[copyIndex()].objectId]"
          },
          "isAdmin": {
            "value": "[equals(variables('domainConfig').groups[copyIndex()].type, 'avdAdmin')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.9.1.41621",
              "templateHash": "16863817949617688466"
            }
          },
          "parameters": {
            "adGroupId": {
              "type": "string"
            },
            "isAdmin": {
              "type": "bool",
              "defaultValue": false
            }
          },
          "variables": {
            "roles": {
              "Virtual Machine Administrator Login": "/providers/Microsoft.Authorization/roleDefinitions/1c0163c0-47e6-4577-8991-ea5c82e286e4",
              "Virtual Machine User Login": "/providers/Microsoft.Authorization/roleDefinitions/fb879df8-f326-4884-b1cf-06f3ad86be52"
            },
            "roleDefinitionId": "[if(parameters('isAdmin'), variables('roles')['Virtual Machine Administrator Login'], variables('roles')['Virtual Machine User Login'])]"
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, resourceGroup().id, parameters('adGroupId'), variables('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[variables('roleDefinitionId')]",
                "principalId": "[parameters('adGroupId')]",
                "principalType": "Group"
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/deployments', 'deploy-avd-rg')]"
      ]
    }
  ]
}